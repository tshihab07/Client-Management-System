{% extends "base.html" %}

{% block title %}Add Client — ClientMS{% endblock %}

{% block header %}Add New Client{% endblock %}

{% block head %}
<style>
    .form-card { max-width: 700px; margin: 0 auto; }
</style>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const amount = document.getElementById('amount');
        const paid = document.getElementById('paid');
        const due = document.getElementById('due');

        function updateDue() {
            const a = parseFloat(amount.value) || 0;
            const p = parseFloat(paid.value) || 0;
            const d = a - p;
            due.value = d.toFixed(2);
            due.className = "w-full px-4 py-2 border border-gray-300 rounded-md " + 
                (d < 0 ? "bg-red-50 text-red-700" : "bg-gray-50 text-gray-700");
        }

        amount?.addEventListener('input', updateDue);
        paid?.addEventListener('input', updateDue);
    });
</script>
{% endblock %}

{% block content %}
<div class="form-card bg-white rounded-xl shadow-sm p-6">
    <form id="addClientForm" class="space-y-6">
        {% if error %}
        <div class="p-3 bg-red-50 text-red-700 border border-red-200 rounded-md">
            {{ error }}
        </div>
        {% endif %}

        <!-- Client Name & Project (side by side) -->
        <div class="flex flex-col md:flex-row md:gap-4">
            <div class="flex-1">
                <label for="client_name" class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                <input 
                    type="text" 
                    id="client_name" 
                    name="client_name"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., John Doe"
                >
            </div>
            <div class="flex-1">
                <label for="project" class="block text-sm font-medium text-gray-700 mb-1">Project *</label>
                <input 
                    type="text" 
                    id="project" 
                    name="project"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., Website Redesign"
                >
            </div>
        </div>

        <!-- Category & Phone (side by side) -->
        <div class="flex flex-col md:flex-row md:gap-4">
            <div class="flex-1">
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select 
                    id="category" 
                    name="category"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                >
                    <option value="">Select a category</option>
                    <option value="Web Development">Web Development</option>
                    <option value="Mobile App">Mobile App</option>
                    <option value="UI/UX Design">UI/UX Design</option>
                    <option value="SEO">SEO</option>
                    <option value="Content Writing">Content Writing</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone (Optional)</label>
                <input 
                    type="tel" 
                    id="phone" 
                    name="phone"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., +8801XXXXXXXXX"
                >
            </div>
        </div>

        <!-- Amount & Paid (side by side) -->
        <div class="flex flex-col md:flex-row md:gap-4">
            <div class="flex-1">
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Total Amount (৳) *</label>
                <input 
                    type="number" 
                    id="amount" 
                    name="amount"
                    step="0.01"
                    min="0.01"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., 15000.00"
                >
            </div>
            <div class="flex-1">
                <label for="paid" class="block text-sm font-medium text-gray-700 mb-1">Paid Amount (৳) *</label>
                <input 
                    type="number" 
                    id="paid" 
                    name="paid"
                    step="0.01"
                    min="0"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., 5000.00"
                    value="0.00"
                >
            </div>
        </div>

        <!-- Due (full width) -->
        <div>
            <label for="due" class="block text-sm font-medium text-gray-700 mb-1">Due Amount (৳) — Auto-calculated</label>
            <input 
                type="text" 
                id="due" 
                readonly
                class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700"
                value="0.00"
            >
            <p class="mt-1 text-xs text-gray-500">Due = Total Amount - Paid</p>
        </div>

        <!-- Submit Button -->
        <div class="pt-4">
            <button 
                type="submit"
                class="px-6 py-2.5 bg-primary hover:bg-opacity-90 text-white font-medium rounded-md transition shadow-sm"
            >
                ✅ Add Client
            </button>
            <a href="/admin" class="ml-3 text-gray-600 hover:text-primary">← Cancel</a>
        </div>
    </form>
</div>

<script>
document.getElementById('addClientForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const clientData = {
        client_name: formData.get('client_name').trim(),
        project: formData.get('project').trim(),
        category: formData.get('category') || undefined,  // ✅ Allow empty
        phone: formData.get('phone')?.trim() || undefined,
        amount: parseFloat(formData.get('amount')),
        paid: parseFloat(formData.get('paid'))
    };

    // Validation
    if (!clientData.client_name || !clientData.project) {
        alert('⚠️ Client Name and Project are required.');
        return;
    }
    if (isNaN(clientData.amount) || clientData.amount <= 0) {
        alert('⚠️ Total amount must be a positive number.');
        return;
    }
    if (isNaN(clientData.paid) || clientData.paid < 0) {
        alert('⚠️ Paid amount must be a non-negative number.');
        return;
    }
    if (clientData.paid > clientData.amount) {
        if (!confirm('⚠️ Paid amount exceeds total. Proceed anyway?')) return;
    }

    try {
        const response = await fetch('/api/clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
        });

        const result = await response.json();
        
        if (response.ok) {
            alert('✅ Client added successfully!');
            window.location.href = '/admin';
        } else {
            const errMsg = Array.isArray(result.detail) 
                ? result.detail.map(d => d.msg).join('; ') 
                : result.detail || 'Unknown error';
            alert('❌ Failed: ' + errMsg);
        }
    } catch (err) {
        alert('❌ Network error: ' + err.message);
    }
});
</script>
{% endblock %}